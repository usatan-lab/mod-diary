{% extends 'base.html' %}

{% block content %}
<section class="editor">
  <header class="ed-head">
    <div class="pill">ğŸ“ New Entry</div>
    <h2>ä»Šæ—¥ã®ãã‚‚ã¡ã‚’æ®‹ãã†</h2>
    <p class="sub">æ°—åˆ†ï¼ˆLv0ã€œ10ï¼‰ã¨ä¸€è¨€ãƒ¡ãƒ¢ã€å¿…è¦ãªã‚‰ç”»åƒã‚‚æ·»ãˆã¦ã€‚</p>
  </header>

  <form method="post" enctype="multipart/form-data" class="ed-grid">

    <!-- å·¦ï¼šãƒ ãƒ¼ãƒ‰ -->
    <div class="card">
      <label class="label">ãƒ ãƒ¼ãƒ‰ <span id="lv" class="lv">5</span>/10</label>

      <div class="mood-face-wrap">
        <div class="mood-face" id="mood_face" aria-hidden="true">ğŸ˜</div>
        <div class="mood-fx" id="mood_fx" aria-hidden="true"></div>
      </div>

      <div class="mood-slider">
        <span class="mood-edge" title="Sad" aria-hidden="true">ğŸ˜­</span>
        <input
          type="range" id="mood_level" name="mood_level"
          min="0" max="10" step="1" value="5"
        
        
          oninput="document.getElementById('lv').textContent=this.value; paintRange(this); updateFace(this.value)">
        <span class="mood-edge" title="Happy" aria-hidden="true">ğŸ˜„</span>
      </div>

      <div class="mood-ticks"><span>0</span><span>2</span><span>4</span><span>6</span><span>8</span><span>10</span></div>
      <div class="mood-label"><span id="mood_text">Lv5 Neutral</span></div>
    </div>

    <!-- å³ï¼šã‚¸ãƒ£ãƒ³ãƒ«/æœ¬æ–‡/ç”»åƒ -->
    <div class="card">
      <label class="label">ã‚¸ãƒ£ãƒ³ãƒ«</label>
      <input type="hidden" name="main_category" id="main_category" value="æ—¥å¸¸ãƒ»ãƒ©ã‚¤ãƒ•ãƒ­ã‚°">
      <div class="chip-row" role="radiogroup" aria-label="ã‚¸ãƒ£ãƒ³ãƒ«">
        <button type="button" class="chip active" data-value="æ—¥å¸¸ãƒ»ãƒ©ã‚¤ãƒ•ãƒ­ã‚°">â˜•ï¸ æ—¥å¸¸</button>
        <button type="button" class="chip" data-value="è¶£å‘³ãƒ»æ¨ã—æ´»">â­ï¸ æ¨ã—æ´»</button>
        <button type="button" class="chip" data-value="å®¶æ—ãƒ»è‚²å…">ğŸ§º å®¶æ—</button>
        <button type="button" class="chip" data-value="ãƒã‚¸ãƒ†ã‚£ãƒ–ãƒ­ã‚°">ğŸŒˆ ãƒã‚¸ãƒ†ã‚£ãƒ–ãƒ­ã‚°</button>
        <button type="button" class="chip" data-value="ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ»æ‹æ„›">â¤ï¸ æ‹æ„›</button>
      </div>

      <label class="label mt">å†…å®¹</label>
      <textarea name="content" id="content" rows="7" placeholder="ä»Šæ—¥ã¯ã“ã‚“ãªã“ã¨ãŒã‚ã£ãŸâ€¦"></textarea>

      <label class="label mt">ç”»åƒã‚’æ·»ä»˜ï¼ˆä»»æ„ï¼‰</label>
      <div class="drop" id="dropzone">
        <input type="file" name="image" id="image" accept="image/*" style="display:none;">
        <img id="preview" style="display:none;max-width:160px;margin-top:.5rem;border-radius:8px;">
        <script>
        document.getElementById('image').addEventListener('change', e=>{
          const f = e.target.files?.[0]; if(!f) return;
          const url = URL.createObjectURL(f);
          const img = document.getElementById('preview');
          img.src = url; img.style.display='block';
        });
        </script>
        <div class="drop-inner">
          <button type="button" id="pick" class="btn-subtle">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¶</button>
          <span class="hint">ã¾ãŸã¯ ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—</span>
        </div>
        <button type="button" id="clearImg" class="link hidden">Ã— ã‚¯ãƒªã‚¢</button>
      </div>

      <div class="actions">
        <span class="hint">âŒ˜/Ctrl + Enter ã§æŠ•ç¨¿</span>
        <button type="submit" class="btn-primary">æŠ•ç¨¿ã™ã‚‹</button>
      </div>
    </div>
  </form>
</section>
{% endblock %}

{% block page_scripts %}
<script>
  // ===== ã‚¸ãƒ£ãƒ³ãƒ«ï¼šãƒãƒƒãƒ— â†’ hidden input =====
  const chipRow = document.querySelector('.chip-row');
  const catInput = document.getElementById('main_category');
  chipRow?.addEventListener('click', (e)=>{
    const btn = e.target.closest('.chip'); if (!btn) return;
    [...chipRow.querySelectorAll('.chip')].forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    catInput.value = btn.dataset.value;
  });

  // ===== ç”»åƒãƒ‰ãƒ­ãƒƒãƒ—ï¼†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ =====
  const drop = document.getElementById('dropzone');
  const pick = document.getElementById('pick');
  const input = document.getElementById('image');
  const prev = document.getElementById('preview');
  const clearBtn = document.getElementById('clearImg');

  function showPreview(file){
    const url = URL.createObjectURL(file);
    prev.src = url; prev.classList.remove('hidden'); clearBtn.classList.remove('hidden');
  }
  function clearPreview(){
    input.value = ""; prev.src = ""; prev.classList.add('hidden'); clearBtn.classList.add('hidden');
  }
  pick?.addEventListener('click', ()=> input?.click());
  input?.addEventListener('change', ()=> { const f = input.files?.[0]; if (f) showPreview(f); });
  ['dragenter','dragover'].forEach(ev=> drop?.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); }));
  ['dragleave','drop'].forEach(ev=> drop?.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); }));
  drop?.addEventListener('drop', e=>{
    if (!e.dataTransfer?.files?.length) return;
    const f = e.dataTransfer.files[0]; if (!f.type.startsWith('image/')) return;
    input.files = e.dataTransfer.files; showPreview(f);
  });
  clearBtn?.addEventListener('click', clearPreview);

  // ===== ãƒ ãƒ¼ãƒ‰UI =====
  const LEVEL_MAP = [
    {emoji:"ğŸ˜­", text:"Very Sad"},{emoji:"ğŸ˜¢", text:"Sad"},{emoji:"ğŸ˜£", text:"Upset"},
    {emoji:"ğŸ˜Ÿ", text:"Anxious"},{emoji:"ğŸ˜®â€ğŸ’¨", text:"Tired"},{emoji:"ğŸ˜", text:"Neutral"},
    {emoji:"ğŸ™", text:"Grateful"},{emoji:"ğŸ™‚", text:"Content"},{emoji:"ğŸ˜„", text:"Happy"},
    {emoji:"ğŸ¤©", text:"Very Happy"},{emoji:"ğŸ¥³", text:"Euphoric"}
  ];
  const REDUCED_MOTION = window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches || false;

  function colorFor(level){
    const hue = 210 - (level/10)*170; // 0â†’é’ / 10â†’æš–è‰²
    return `hsl(${hue} 75% 50%)`;
  }
  function paintRange(el){
    const min = +el.min || 0, max = +el.max || 10;
    const val = ((el.value - min) / (max - min)) * 100;
    const c = colorFor(+el.value);
    el.style.background = `linear-gradient(to right, ${c} 0%, ${c} ${val}%, #ddd ${val}%, #ddd 100%)`;
  }

  function applyFaceClasses(level){
    const face = document.getElementById('mood_face');
    face.classList.remove('pulse-soft','pulse-strong','bounce');
    if (level <= 3)      face.classList.add('pulse-soft');
    else if (level >= 8) face.classList.add('pulse-strong');
    if (!REDUCED_MOTION){
      face.classList.add('bounce');
      setTimeout(()=>face.classList.remove('bounce'), 650);
    }
  }

  // ç”Ÿæˆâ†’CSSã‚¢ãƒ‹ãƒ¡â†’çµ‚ã‚ã£ãŸã‚‰å‰Šé™¤
  function spawnFx(cls, text, styles){
    const s = document.createElement('span');
    s.className = cls;
    s.textContent = text;
    Object.assign(s.style, styles);
    s.addEventListener('animationend', ()=> s.remove());
    return s;
  }

  // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆæœ¬ä½“ï¼ˆå·¦å³ã«æ•£ã‚‰ã°ã‚‹ï¼†ç«¯ã§åˆ‡ã‚Œãªã„ï¼‰
  function updateFX(level){
    const fx = document.getElementById('mood_fx');
    if (!fx) return;
    fx.innerHTML = '';
    if (REDUCED_MOTION) return;

    const PAD = 3; // å·¦å³3%ã‚’ç©ºã‘ã‚‹
    const randX = () => (PAD + Math.random()*(100 - PAD*2)).toFixed(2);

    if (Number(level) <= 3){
      for (let i=0; i<5; i++){
        fx.appendChild(spawnFx('fx-drop','ğŸ’§',{
          left: `calc(${randX()}% - .5rem)`,
          animationDelay: (Math.random()*0.5)+'s',
          fontSize: (0.9 + Math.random()*0.3)+'rem'
        }));
      }
    } else if (Number(level) >= 8){
      for (let i=0; i<7; i++){
        fx.appendChild(spawnFx('fx-sparkle', Math.random()<0.7?'âœ¨':'ğŸŒŸ', {
          left: `calc(${randX()}% - .5rem)`,
          animationDelay: (Math.random()*0.6)+'s',
          fontSize: (0.9 + Math.random()*0.5)+'rem'
        }));
      }
    }
  }

  function updateFace(level){
    level = Number(level);
    const face = document.getElementById('mood_face');
    const text = document.getElementById('mood_text');
    const item = LEVEL_MAP[level] || {emoji:"ğŸ˜", text:"Neutral"};
    face.textContent = item.emoji;
    if (text) text.textContent = `Lv${level} ${item.text}`;
    const lvSpan = document.getElementById('lv');
    if (lvSpan) lvSpan.style.color = colorFor(level);
    paintRange(document.getElementById('mood_level'));
    applyFaceClasses(level);
    updateFX(level);
  }

  // åˆæœŸåæ˜ 
  document.addEventListener('DOMContentLoaded', ()=>{
    const el = document.getElementById('mood_level');
    if (el){ paintRange(el); updateFace(el.value); }
  });
</script>
{% endblock %}